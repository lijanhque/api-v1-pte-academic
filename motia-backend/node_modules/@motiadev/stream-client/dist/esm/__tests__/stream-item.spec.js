import { StreamItemSubscription } from '../src/stream-item';
describe('StreamItemSubscription', () => {
    const joinMessage = {
        streamName: 'test-stream',
        groupId: 'test-group',
        subscriptionId: 'sub-1',
    };
    function makeMessage(type, data, timestamp = Date.now()) {
        return {
            streamName: 'test-stream',
            groupId: 'test-group',
            timestamp,
            event: { type, ...(type === 'event' ? { event: data } : { data }) },
        };
    }
    it('notifies change listeners on state change', () => {
        const sub = new StreamItemSubscription(joinMessage);
        const listener = jest.fn();
        sub.addChangeListener(listener);
        const syncData = { id: '1', name: 'A', value: 1 };
        sub.listener(makeMessage('sync', syncData));
        expect(listener).toHaveBeenCalledWith(syncData);
    });
    it('should discard old events', () => {
        const sub = new StreamItemSubscription(joinMessage);
        const syncData = { id: '1', name: 'A', value: 1 };
        const oldSyncData = { id: '1', name: 'B', value: 3 };
        sub.listener(makeMessage('sync', syncData));
        sub.listener(makeMessage('sync', oldSyncData, Date.now() - 1000));
        expect(sub.getState()).toEqual(syncData);
    });
    it('should update item', () => {
        const sub = new StreamItemSubscription(joinMessage);
        const syncData = { id: '1', name: 'A', value: 1 };
        sub.listener(makeMessage('sync', syncData));
        sub.listener(makeMessage('update', { id: '1', name: 'A1', value: 2 }, Date.now() + 1000));
        expect(sub.getState()).toEqual({ id: '1', name: 'A1', value: 2 });
    });
    it('should remove item', () => {
        const sub = new StreamItemSubscription(joinMessage);
        const syncData = { id: '1', name: 'A', value: 1 };
        sub.listener(makeMessage('sync', syncData));
        sub.listener(makeMessage('delete', { id: '1' }, Date.now() + 1000));
        expect(sub.getState()).toEqual(null);
    });
});
