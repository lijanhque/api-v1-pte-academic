import { Stream } from '@motiadev/stream-client-node';
import { cloudApi } from './cloud-api';
import { cloudApiWsUrl } from './cloud-api/endpoints';
export const deploy = async (input) => {
    const { envVars, deploymentToken, builder, deploymentId, listener, context, ci } = input;
    const client = new Stream(cloudApiWsUrl);
    const response = await cloudApi.startDeployment({
        deploymentToken,
        envVars,
        steps: builder.stepsConfig,
        streams: builder.streamsConfig,
        routers: builder.routersConfig,
    });
    context.log('starting-deployment', (message) => message.tag('success').append('Deployment started'));
    if (!ci) {
        const subscription = client.subscribeItem('deployment', deploymentId, 'data');
        const interval = setInterval(() => {
            const state = subscription.getState();
            if (state) {
                listener.onDeployProgress(state);
            }
        }, 1000);
        await new Promise((resolve) => {
            subscription.addChangeListener((item) => {
                if (item && ['failed', 'completed'].includes(item.status)) {
                    clearInterval(interval);
                    listener.onDeployProgress(item);
                    if (item.status === 'completed') {
                        listener.onDeployEnd({
                            output: item.outputs,
                        });
                    }
                    client.close();
                    resolve();
                }
            });
        });
    }
    else {
        context.log('deploy-progress', (message) => message
            .tag('progress')
            .append(`Deployment in progress... You can view the deployment at ${response?.deploymentUrl}`));
        client.close();
    }
};
