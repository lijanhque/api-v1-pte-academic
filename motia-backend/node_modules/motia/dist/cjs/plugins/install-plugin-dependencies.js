"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.installPluginDependencies = void 0;
const node_fs_1 = __importDefault(require("node:fs"));
const node_path_1 = __importDefault(require("node:path"));
const execute_command_1 = require("../utils/execute-command");
const get_package_manager_1 = require("../utils/get-package-manager");
const version_1 = require("../version");
const plugin_dependencies_1 = require("./plugin-dependencies");
const installPluginDependencies = async (baseDir, printer) => {
    const packageJsonPath = node_path_1.default.join(baseDir, 'package.json');
    if (!node_fs_1.default.existsSync(packageJsonPath)) {
        printer.printPluginWarn('No package.json found, skipping plugin dependency installation');
        return;
    }
    const packageJson = JSON.parse(node_fs_1.default.readFileSync(packageJsonPath, 'utf-8'));
    if (!packageJson.dependencies) {
        packageJson.dependencies = {};
    }
    const missingDependencies = [];
    for (const dep of plugin_dependencies_1.pluginDependencies) {
        if (packageJson.devDependencies?.[dep]) {
            delete packageJson.devDependencies[dep];
        }
        if (!packageJson.dependencies[dep]) {
            packageJson.dependencies[dep] = version_1.version;
            missingDependencies.push(dep);
        }
    }
    if (missingDependencies.length === 0) {
        printer.printPluginLog('All plugin dependencies already installed');
        return;
    }
    printer.printPluginLog(`Adding missing plugin dependencies: ${missingDependencies.join(', ')}`);
    node_fs_1.default.writeFileSync(packageJsonPath, `${JSON.stringify(packageJson, null, 2)}\n`);
    printer.printPluginLog('Updated package.json with plugin dependencies');
    let packageManager = (0, get_package_manager_1.getPackageManager)(baseDir);
    if (packageManager === 'unknown') {
        printer.printPluginError('No package manager found, using npm as default');
        packageManager = 'npm';
    }
    printer.printPluginLog(`Installing dependencies using ${packageManager}...`);
    const installCommands = {
        npm: 'npm install',
        yarn: 'yarn install',
        pnpm: 'pnpm install',
    };
    const installCommand = installCommands[packageManager] || 'npm install';
    try {
        await (0, execute_command_1.executeCommand)(installCommand, baseDir, { silent: false });
        printer.printPluginLog('Plugin dependencies installed successfully');
    }
    catch (error) {
        printer.printPluginError('Failed to install plugin dependencies:', error);
        printer.printPluginWarn(`Please run '${installCommand}' manually to install the dependencies`);
    }
};
exports.installPluginDependencies = installPluginDependencies;
