"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.generateTypes = void 0;
const core_1 = require("@motiadev/core");
const crypto_1 = require("crypto");
const generate_locked_data_1 = require("./generate-locked-data");
const redis_memory_manager_1 = require("./redis-memory-manager");
const version = `${(0, crypto_1.randomUUID)()}:${Math.floor(Date.now() / 1000)}`;
const generateTypes = async (projectDir) => {
    const files = (0, generate_locked_data_1.getStepFiles)(projectDir);
    const streamsFiles = (0, generate_locked_data_1.getStreamFiles)(projectDir);
    const redisClient = await (0, redis_memory_manager_1.instanceRedisMemoryServer)(projectDir, false);
    const lockedData = new core_1.LockedData(projectDir, new core_1.MemoryStreamAdapterManager(), new core_1.Printer(projectDir), redisClient);
    for (const filePath of files) {
        const config = await (0, core_1.getStepConfig)(filePath, projectDir);
        if (config) {
            lockedData.createStep({ filePath, version, config }, { disableTypeCreation: true });
        }
    }
    for (const filePath of streamsFiles) {
        const config = await (0, core_1.getStreamConfig)(filePath, projectDir);
        if (config) {
            lockedData.createStream({ filePath, config }, { disableTypeCreation: true });
        }
    }
    lockedData.saveTypes();
    console.log('âœ¨ Types created successfully');
};
exports.generateTypes = generateTypes;
