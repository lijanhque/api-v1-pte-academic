"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const fs_1 = __importDefault(require("fs"));
const os_1 = require("os");
const path_1 = __importDefault(require("path"));
const read_requirements_1 = require("../read-requirements");
describe('readRequirements', () => {
    let tempFilePath;
    beforeEach(() => {
        // Create a temporary file path
        tempFilePath = path_1.default.join((0, os_1.tmpdir)(), `requirements-${Date.now()}.txt`);
    });
    afterEach(() => {
        // Clean up temporary file if it exists
        if (fs_1.default.existsSync(tempFilePath)) {
            fs_1.default.unlinkSync(tempFilePath);
        }
    });
    test('reads basic requirements correctly', () => {
        const content = `requests==2.25.1
numpy>=1.20.0
flask~=2.0`;
        fs_1.default.writeFileSync(tempFilePath, content);
        const requirements = (0, read_requirements_1.readRequirements)(tempFilePath);
        expect(Object.keys(requirements)).toHaveLength(3);
        expect(requirements.requests).toBe('requests==2.25.1');
        expect(requirements.numpy).toBe('numpy>=1.20.0');
        expect(requirements.flask).toBe('flask~=2.0');
    });
    test('skips comments and empty lines', () => {
        const content = `# This is a comment
requests==2.25.1

# Another comment
numpy>=1.20.0

flask~=2.0`;
        fs_1.default.writeFileSync(tempFilePath, content);
        const requirements = (0, read_requirements_1.readRequirements)(tempFilePath);
        expect(Object.keys(requirements)).toHaveLength(3);
        expect(requirements.requests).toBe('requests==2.25.1');
        expect(requirements.numpy).toBe('numpy>=1.20.0');
        expect(requirements.flask).toBe('flask~=2.0');
    });
    test('handles requirements with extra dependencies', () => {
        const content = `requests[security]==2.25.1
flask[async]==2.0.1`;
        fs_1.default.writeFileSync(tempFilePath, content);
        const requirements = (0, read_requirements_1.readRequirements)(tempFilePath);
        expect(Object.keys(requirements)).toHaveLength(2);
        expect(requirements['requests']).toBe('requests[security]==2.25.1');
        expect(requirements['flask']).toBe('flask[async]==2.0.1');
    });
    test('handles empty requirements file', () => {
        const content = `# Only comments

# And empty lines`;
        fs_1.default.writeFileSync(tempFilePath, content);
        const requirements = (0, read_requirements_1.readRequirements)(tempFilePath);
        expect(Object.keys(requirements)).toHaveLength(0);
    });
    test('handles malformed lines gracefully', () => {
        const content = `requests==2.25.1
# Valid package
numpy>=1.20.0
==invalid-version-only`;
        fs_1.default.writeFileSync(tempFilePath, content);
        const requirements = (0, read_requirements_1.readRequirements)(tempFilePath);
        expect(Object.keys(requirements)).toHaveLength(2);
        expect(requirements.requests).toBe('requests==2.25.1');
        expect(requirements.numpy).toBe('numpy>=1.20.0');
    });
    test('handles mixed line endings', () => {
        const content = 'requests==2.25.1\r\nnumpy>=1.20.0\nflask~=2.0';
        fs_1.default.writeFileSync(tempFilePath, content);
        const requirements = (0, read_requirements_1.readRequirements)(tempFilePath);
        expect(Object.keys(requirements)).toHaveLength(3);
        expect(requirements.requests).toBe('requests==2.25.1');
        expect(requirements.numpy).toBe('numpy>=1.20.0');
        expect(requirements.flask).toBe('flask~=2.0');
    });
    test('handles requirements with no versions', () => {
        const content = ['requests', 'numpy', 'flask'].join('\n');
        fs_1.default.writeFileSync(tempFilePath, content);
        const requirements = (0, read_requirements_1.readRequirements)(tempFilePath);
        expect(Object.keys(requirements)).toHaveLength(3);
        expect(requirements.requests).toBe('requests');
        expect(requirements.numpy).toBe('numpy');
        expect(requirements.flask).toBe('flask');
    });
});
