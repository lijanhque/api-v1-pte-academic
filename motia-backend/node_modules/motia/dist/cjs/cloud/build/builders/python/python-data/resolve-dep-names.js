"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.resolveDepNames = void 0;
const fs_1 = __importDefault(require("fs"));
const path_1 = __importDefault(require("path"));
const python_errors_1 = require("./python-errors");
/**
 * Resolve the name of the import from the name of the package
 * @param depName the package name
 * @returns a map of the import name to the package name
 */
const resolveDepNames = (depNames, sitePackagesDir) => {
    const folders = fs_1.default
        .readdirSync(sitePackagesDir)
        .filter((folder) => fs_1.default.statSync(path_1.default.join(sitePackagesDir, folder)).isDirectory());
    const result = {};
    for (const depName of depNames) {
        const regex = new RegExp(`^${depName.replace(/-/g, '[-_]')}-.*\\.dist-info$`);
        const folder = folders.find((folder) => regex.test(folder));
        if (folder) {
            const topLevelFile = fs_1.default.existsSync(path_1.default.join(sitePackagesDir, folder, 'top_level.txt'));
            const recordFile = fs_1.default.existsSync(path_1.default.join(sitePackagesDir, folder, 'RECORD'));
            if (topLevelFile) {
                const topLevel = fs_1.default.readFileSync(path_1.default.join(sitePackagesDir, folder, 'top_level.txt'), 'utf8').trim();
                result[topLevel] = depName;
            }
            else if (recordFile) {
                const record = fs_1.default.readFileSync(path_1.default.join(sitePackagesDir, folder, 'RECORD'), 'utf8').trim();
                // Parse RECORD file to find the main module name
                const recordLines = record.split('\n').filter((line) => line.trim());
                for (const line of recordLines) {
                    // RECORD format: path/__init__.py,sha256=hash,size
                    const match = /^([^/]+)\/__init__\.py,/.exec(line);
                    if (match) {
                        result[match[1]] = depName;
                    }
                }
            }
            else {
                throw new python_errors_1.PythonError(`Could not find dependency name in site-packages: ${depName}`, depName);
            }
        }
        else {
            throw new python_errors_1.PythonError(`Could not find dependency name in site-packages: ${depName}`, depName);
        }
    }
    return result;
};
exports.resolveDepNames = resolveDepNames;
