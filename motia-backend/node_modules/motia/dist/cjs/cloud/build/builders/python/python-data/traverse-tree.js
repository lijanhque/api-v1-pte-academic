"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.traverseTree = void 0;
const fs_1 = __importDefault(require("fs"));
const path_1 = __importDefault(require("path"));
const convert_import_path_1 = require("./convert-import-path");
const get_dependencies_from_file_1 = require("./get-dependencies-from-file");
const python_errors_1 = require("./python-errors");
const traverseTree = (rootDir, filePath, result, dependenciesMap, 
// optional
fileContent) => {
    const fileAbsolutePath = path_1.default.join(rootDir, filePath);
    if (!fileContent && !fs_1.default.existsSync(fileAbsolutePath)) {
        throw new python_errors_1.PythonFileNotFoundError(filePath);
    }
    const initPath = path_1.default.resolve(path_1.default.dirname(fileAbsolutePath), '__init__.py');
    if (fs_1.default.existsSync(initPath)) {
        result.files.add(initPath.replace(rootDir, ''));
    }
    const content = fileContent || fs_1.default.readFileSync(fileAbsolutePath, 'utf8');
    const dependencies = (0, get_dependencies_from_file_1.getDependenciesFromFile)(content, filePath, dependenciesMap);
    result.files.add(filePath);
    dependencies.externalDependencies.forEach((dependency) => {
        result.externalDependencies.add(dependency);
    });
    dependencies.standardLibDependencies.forEach((dependency) => {
        result.standardLibDependencies.add(dependency);
    });
    for (const dependency of dependencies.projectDependencies) {
        const pythonPath = (0, convert_import_path_1.convertImportToPath)(dependency);
        const fileFolder = path_1.default.dirname(fileAbsolutePath);
        const dependencyFilePath = path_1.default.resolve(fileFolder, `${pythonPath}.py`);
        const dependencyPath = dependencyFilePath.replace(rootDir, '');
        if (!result.files.has(dependencyPath)) {
            try {
                (0, exports.traverseTree)(rootDir, dependencyPath, result, dependenciesMap);
            }
            catch (error) {
                if (error instanceof python_errors_1.PythonFileNotFoundError) {
                    if (dependency[0] !== '.') {
                        // try root folder
                        try {
                            const rootDependencyFilePath = path_1.default.resolve(rootDir, `${pythonPath}.py`).replace(rootDir, '');
                            return (0, exports.traverseTree)(rootDir, rootDependencyFilePath, result, dependenciesMap);
                        }
                        catch (_error) {
                            // let it throw
                        }
                    }
                    throw new python_errors_1.PythonImportNotFoundError(filePath, dependency);
                }
                throw error;
            }
        }
    }
};
exports.traverseTree = traverseTree;
