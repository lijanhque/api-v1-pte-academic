"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const glob_1 = require("glob");
const path_1 = __importDefault(require("path"));
const extract_python_data_1 = require("../extract-python-data");
const python_errors_1 = require("../python-errors");
const read_requirements_1 = require("../read-requirements");
describe('extractPythonData', () => {
    test('extracts python data correctly', () => {
        const rootDir = path_1.default.join(__dirname, './examples/example-1');
        const requirements = (0, read_requirements_1.readRequirements)(path_1.default.join(rootDir, 'requirements.txt'));
        const steps = (0, glob_1.globSync)('**/*_step.py', { absolute: false, cwd: path_1.default.join(rootDir, 'steps') });
        for (const file of steps) {
            const result = (0, extract_python_data_1.extractPythonData)(rootDir, `/steps/${file}`, requirements);
            expect(result).toEqual({
                standardLibDependencies: ['typing', 'enum'],
                externalDependencies: { httpx: 'httpx>=0.28.1', pydantic: 'pydantic>=2.6.1' },
                files: ['/steps/api_step.py', '/src/__init__.py', '/src/pet_store.py', '/src/types.py'],
            });
        }
    });
    test('extracts python data correctly with invalid dependency', () => {
        const rootDir = path_1.default.join(__dirname, './examples/invalid-dependency');
        const requirements = (0, read_requirements_1.readRequirements)(path_1.default.join(rootDir, 'requirements.txt'));
        expect(() => (0, extract_python_data_1.extractPythonData)(rootDir, `/steps/api_step.py`, requirements)).toThrow(python_errors_1.PythonImportNotFoundError);
    });
    test('extracts python data correctly with compilation error', () => {
        const rootDir = path_1.default.join(__dirname, './examples/compilation-error');
        const requirements = (0, read_requirements_1.readRequirements)(path_1.default.join(rootDir, 'requirements.txt'));
        expect(() => (0, extract_python_data_1.extractPythonData)(rootDir, `/steps/api_step.py`, requirements)).toThrow(new python_errors_1.PythonError("Compilation error: no viable alternative at input ':' at line 3:10 in /steps/api_step.py", '/steps/api_step.py'));
    });
    test('extracts python data with nested import from requirements', () => {
        const rootDir = path_1.default.join(__dirname, './examples/chessarena');
        const requirements = (0, read_requirements_1.readRequirements)(path_1.default.join(rootDir, 'requirements.txt'));
        const result = (0, extract_python_data_1.extractPythonData)(rootDir, `/steps/evaluate_player_move_step.py`, requirements);
        expect(result.externalDependencies).toEqual({ chess: 'chess>=1.0.0', pydantic: 'pydantic>=2.6.1' });
    });
});
