"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.printDeploymentStatus = exports.getStatusColor = void 0;
const colors_1 = __importDefault(require("colors"));
let spinnerIndex = 0;
const getStatusColor = (status) => {
    switch (status) {
        case 'completed':
            return colors_1.default.green;
        case 'failed':
            return colors_1.default.red;
        case 'progress':
            return colors_1.default.yellow;
        case 'pending':
            return colors_1.default.gray;
        default:
            return colors_1.default.gray;
    }
};
exports.getStatusColor = getStatusColor;
const printDeploymentStatus = (data, context) => {
    const spinners = ['⠋', '⠙', '⠹', '⠸', '⠼', '⠴', '⠦', '⠧', '⠇', '⠏'];
    const getSpinner = () => {
        const spinner = spinners[spinnerIndex];
        spinnerIndex = (spinnerIndex + 1) % spinners.length;
        return colors_1.default.gray(spinner);
    };
    context.log('deployment-status-blank-1', (message) => message.append(''));
    const generateEmitList = (emits = []) => {
        return emits.map((e) => colors_1.default.white(`⌁ ${e}`)).join(colors_1.default.white(', '));
    };
    const getStatus = (status) => {
        return status === 'failed' ? colors_1.default.red('✘') : status === 'completed' ? colors_1.default.green('✓') : getSpinner();
    };
    const lambda = (stepName, color) => color(`λ ${stepName}`);
    const eventStatus = data.events.reduce((acc, event) => {
        return acc === 'failed' ? 'failed' : acc === 'completed' ? event.status : acc;
    }, 'completed');
    const cronStatus = data.cron.reduce((acc, cron) => {
        return acc === 'failed' ? 'failed' : acc === 'completed' ? cron.status : acc;
    }, 'completed');
    const apigwStatus = data.endpoints.reduce((acc, endpoint) => {
        return acc === 'failed' ? 'failed' : acc === 'completed' ? endpoint.status : acc;
    }, 'completed');
    context.log('deployment-status-step-handler', (message) => message.append(`[${getStatus(eventStatus)}]   [λ Step Handler]`));
    // Display event listeners
    data.events.forEach((event) => {
        const color = (0, exports.getStatusColor)(event.status);
        const status = getStatus(event.status);
        const topicList = generateEmitList(event.topics);
        context.log(`event-${event.stepName}`, (message) => {
            message.append(`[${status}]    ↳ [${topicList}] → [≡ ${color(event.queue)}] → [${lambda(event.stepName, color)}]`);
        });
    });
    context.log('deployment-status-blank-2', (message) => message.append(''));
    // Display API Gateway
    context.log('deployment-status-api-gateway', (message) => message.append(`[${getStatus(apigwStatus)}]   [⛩ API Gateway]`));
    data.endpoints.forEach((endpoint) => {
        const color = (0, exports.getStatusColor)(endpoint.status);
        const status = getStatus(endpoint.status);
        const emitsList = generateEmitList(endpoint.emits);
        context.log(`endpoint-${endpoint.stepName}`, (message) => {
            message.append(`[${status}]    ↳ /${endpoint.method} ${endpoint.path} → [${lambda(endpoint.stepName, color)}] → [${emitsList}]`);
        });
    });
    context.log('deployment-status-blank-3', (message) => message.append(''));
    // Display Cron jobs
    context.log('deployment-status-cron', (message) => message.append(`[${getStatus(cronStatus)}]   [↺ Cron]`));
    if (data.cron.length > 0) {
        data.cron.forEach((cronJob) => {
            const color = (0, exports.getStatusColor)(cronJob.status);
            const status = getStatus(cronJob.status);
            const emitsList = generateEmitList(cronJob.emits);
            context.log(`cron-${cronJob.stepName}`, (message) => {
                message.append(`[${status}]    ↳ ${cronJob.cron} → [${lambda(cronJob.stepName, color)}] → [${emitsList}]`);
            });
        });
    }
    else {
        context.log('deployment-status-cron-no-jobs', (message) => message.append(`[${colors_1.default.green('✓')}]    ↳ No cron jobs configured`));
    }
    // Display Legend
    context.log('deployment-status-legent', (message) => message.append('\nLegend'));
    context.log('deployment-status-legent-queue', (message) => message.append('↳ ≡ Queue'));
    context.log('deployment-status-legent-api-gateway', (message) => message.append('↳ ⛩ API Gateway'));
    context.log('deployment-status-legent-topic', (message) => message.append('↳ ⌁ Topic'));
    context.log('deployment-status-legent-function-handler', (message) => message.append('↳ λ Step Handler'));
    context.log('deployment-status-legent-cron-job', (message) => message.append('↳ ↺ Cron Job'));
};
exports.printDeploymentStatus = printDeploymentStatus;
