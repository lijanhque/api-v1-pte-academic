"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.deploy = void 0;
const stream_client_node_1 = require("@motiadev/stream-client-node");
const cloud_api_1 = require("./cloud-api");
const endpoints_1 = require("./cloud-api/endpoints");
const deploy = async (input) => {
    const { envVars, deploymentToken, builder, deploymentId, listener, context, ci } = input;
    const client = new stream_client_node_1.Stream(endpoints_1.cloudApiWsUrl);
    const response = await cloud_api_1.cloudApi.startDeployment({
        deploymentToken,
        envVars,
        steps: builder.stepsConfig,
        streams: builder.streamsConfig,
        routers: builder.routersConfig,
    });
    context.log('starting-deployment', (message) => message.tag('success').append('Deployment started'));
    if (!ci) {
        const subscription = client.subscribeItem('deployment', deploymentId, 'data');
        const interval = setInterval(() => {
            const state = subscription.getState();
            if (state) {
                listener.onDeployProgress(state);
            }
        }, 1000);
        await new Promise((resolve) => {
            subscription.addChangeListener((item) => {
                if (item && ['failed', 'completed'].includes(item.status)) {
                    clearInterval(interval);
                    listener.onDeployProgress(item);
                    if (item.status === 'completed') {
                        listener.onDeployEnd({
                            output: item.outputs,
                        });
                    }
                    client.close();
                    resolve();
                }
            });
        });
    }
    else {
        context.log('deploy-progress', (message) => message
            .tag('progress')
            .append(`Deployment in progress... You can view the deployment at ${response?.deploymentUrl}`));
        client.close();
    }
};
exports.deploy = deploy;
