"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.checkPythonVersionExists = checkPythonVersionExists;
exports.getPythonCommand = getPythonCommand;
exports.findPythonSitePackagesDir = findPythonSitePackagesDir;
const fs_1 = __importDefault(require("fs"));
const path_1 = __importDefault(require("path"));
const execute_command_1 = require("./execute-command");
const internal_logger_1 = require("./internal-logger");
async function checkPythonVersionExists(pythonCmd, baseDir) {
    try {
        await (0, execute_command_1.executeCommand)(`${pythonCmd} --version`, baseDir, { silent: true });
        return true;
    }
    catch (error) {
        return false;
    }
}
async function getPythonCommand(requestedVersion, baseDir) {
    // Check if python{version} exists (e.g., python3.13)
    const specificPythonCmd = `python${requestedVersion}`;
    if (await checkPythonVersionExists(specificPythonCmd, baseDir)) {
        return specificPythonCmd;
    }
    // Check if python exists and is version 3+
    try {
        const result = await (0, execute_command_1.executeCommand)('python --version', baseDir, { silent: true });
        const versionMatch = result.match(/Python\s+(\d+)\.(\d+)\.(\d+)/);
        if (versionMatch && parseInt(versionMatch[1], 10) >= 3) {
            return 'python';
        }
    }
    catch (error) {
        // If error, python command doesn't exist or can't be executed
    }
    throw new Error('No compatible Python 3 installation found. Please install Python 3.');
}
function findPythonSitePackagesDir(venvLibPath, pythonVersion) {
    let pythonVersionPath = `python${pythonVersion}`;
    if (!venvLibPath || !pythonVersion) {
        return pythonVersionPath;
    }
    try {
        // Check if the exact version exists
        if (venvLibPath && !fs_1.default.existsSync(path_1.default.join(venvLibPath, pythonVersionPath))) {
            // Try to find any python3.x directory
            const libContents = fs_1.default.readdirSync(venvLibPath);
            const pythonDirs = libContents.filter((item) => item.startsWith('python3'));
            if (pythonDirs.length > 0) {
                // Use the first python3.x directory found
                pythonVersionPath = pythonDirs[0];
                internal_logger_1.internalLogger.info('Found Python directory', pythonVersionPath);
            }
        }
    }
    catch (error) {
        internal_logger_1.internalLogger.warn('Could not determine Python version directory', error.message);
    }
    return pythonVersionPath;
}
