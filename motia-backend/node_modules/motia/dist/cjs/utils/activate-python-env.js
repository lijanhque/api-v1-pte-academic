"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.activatePythonVenv = exports.getSitePackagesPath = void 0;
const fs_1 = __importDefault(require("fs"));
const path_1 = __importDefault(require("path"));
const internal_logger_1 = require("./internal-logger");
const python_version_utils_1 = require("./python-version-utils");
const getSitePackagesPath = ({ baseDir, pythonVersion = '3.13' }) => {
    const venvPath = path_1.default.join(baseDir, 'python_modules');
    const libPath = path_1.default.join(venvPath, 'lib');
    const actualPythonVersionPath = (0, python_version_utils_1.findPythonSitePackagesDir)(libPath, pythonVersion);
    return path_1.default.join(venvPath, 'lib', actualPythonVersionPath, 'site-packages');
};
exports.getSitePackagesPath = getSitePackagesPath;
const activatePythonVenv = ({ baseDir, isVerbose = false, pythonVersion = '3.13' }) => {
    internal_logger_1.internalLogger.info('Activating Python environment');
    // Set the virtual environment path
    const venvPath = path_1.default.join(baseDir, 'python_modules');
    const venvBinPath = path_1.default.join(venvPath, process.platform === 'win32' ? 'Scripts' : 'bin');
    // Find the Python version directory using the utility function
    const sitePackagesPath = (0, exports.getSitePackagesPath)({ baseDir, pythonVersion });
    // Verify that the virtual environment exists
    if (fs_1.default.existsSync(venvPath)) {
        // Add virtual environment to PATH
        process.env.PATH = `${venvBinPath}${path_1.default.delimiter}${process.env.PATH}`;
        // Set VIRTUAL_ENV environment variable
        process.env.VIRTUAL_ENV = venvPath;
        // Set PYTHON_SITE_PACKAGES with the site-packages path
        process.env.PYTHON_SITE_PACKAGES = sitePackagesPath;
        // Remove PYTHONHOME if it exists as it can interfere with venv
        delete process.env.PYTHONHOME;
        // Log Python environment information if verbose mode is enabled
        if (isVerbose) {
            const pythonPath = process.platform === 'win32' ? path_1.default.join(venvBinPath, 'python.exe') : path_1.default.join(venvBinPath, 'python');
            const relativePath = (path) => path.replace(baseDir, '<projectDir>');
            internal_logger_1.internalLogger.info('Using Python', relativePath(pythonPath));
            internal_logger_1.internalLogger.info('Site-packages path', relativePath(sitePackagesPath));
        }
    }
    else {
        internal_logger_1.internalLogger.error('Python virtual environment not found in python_modules/');
        internal_logger_1.internalLogger.error('Please run `motia install` to create a new virtual environment');
    }
};
exports.activatePythonVenv = activatePythonVenv;
