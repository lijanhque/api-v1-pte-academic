"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.install = exports.pythonInstall = void 0;
const fs_1 = __importDefault(require("fs"));
const path_1 = __importDefault(require("path"));
const generate_locked_data_1 = require("./generate-locked-data");
const activate_python_env_1 = require("./utils/activate-python-env");
const ensure_uv_1 = require("./utils/ensure-uv");
const execute_command_1 = require("./utils/execute-command");
const install_lambda_python_packages_1 = require("./utils/install-lambda-python-packages");
const python_version_utils_1 = require("./utils/python-version-utils");
const pythonInstall = async ({ baseDir, isVerbose = false, pythonVersion = '3.13', }) => {
    const venvPath = path_1.default.join(baseDir, 'python_modules');
    console.log('ðŸ“¦ Installing Python dependencies...', venvPath);
    const coreRequirementsPath = path_1.default.join(baseDir, 'node_modules', 'motia', 'dist', 'requirements-core.txt');
    const snapRequirementsPath = path_1.default.join(baseDir, 'node_modules', 'motia', 'dist', 'requirements-snap.txt');
    const localRequirements = path_1.default.join(baseDir, 'requirements.txt');
    const requirementsList = [coreRequirementsPath, snapRequirementsPath, localRequirements];
    try {
        // Get the appropriate Python command
        const pythonCmd = await (0, python_version_utils_1.getPythonCommand)(pythonVersion, baseDir);
        if (isVerbose) {
            console.log(`ðŸ Using Python command: ${pythonCmd}`);
        }
        // Check if virtual environment exists
        if (!fs_1.default.existsSync(venvPath)) {
            console.log('ðŸ“¦ Creating Python virtual environment...');
            await (0, execute_command_1.executeCommand)(`${pythonCmd} -m venv python_modules`, baseDir);
        }
        (0, activate_python_env_1.activatePythonVenv)({ baseDir, isVerbose, pythonVersion });
        // Ensure UV is installed
        console.log('ðŸ”§ Checking UV installation...');
        await (0, ensure_uv_1.ensureUvInstalled)();
        console.log('âœ… UV is available');
        (0, install_lambda_python_packages_1.installLambdaPythonPackages)({ isVerbose, requirementsList });
        // Install requirements
        console.log('ðŸ“¥ Installing Python dependencies...');
        // Core requirements
        for (const requirement of requirementsList) {
            if (fs_1.default.existsSync(requirement)) {
                if (isVerbose) {
                    console.log('ðŸ“„ Using requirements from:', requirement);
                }
                await (0, execute_command_1.executeCommand)(`pip install -r "${requirement}" --only-binary=:all:`, baseDir);
            }
        }
    }
    catch (error) {
        const errorMessage = error instanceof Error ? error.message : String(error);
        console.error('âŒ Installation failed:', errorMessage);
        process.exit(1);
    }
};
exports.pythonInstall = pythonInstall;
const install = async ({ isVerbose = false, pythonVersion = '3.13' }) => {
    const baseDir = process.cwd();
    const steps = (0, generate_locked_data_1.getStepFiles)(baseDir);
    if (steps.some((file) => file.endsWith('.py'))) {
        await (0, exports.pythonInstall)({ baseDir, isVerbose, pythonVersion });
    }
    console.info('âœ… Installation completed successfully!');
    process.exit(0);
};
exports.install = install;
